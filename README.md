

# ç°¡ä»‹: 

æ­¤ç¨‹å¼æ¡†æ¶çš„ç”¨é€”æ˜¯å¹«åŠ©å¤šä»»å‹™å¯¦é©—çš„å”ä½œèˆ‡é–‹ç™¼ï¼Œæä¾›äº†å¯¦é©—çš„è¨“ç·´ã€æ¸¬è©¦ã€Debugã€å‰è™•ç†ç”¨çš„å…±ç”¨æ¨¡çµ„ï¼Œä¸¦ä¸”æ”¯æ´Checkpointï¼Œè®“æ¯æ¬¡å¯¦é©—ç”¢ç”Ÿçš„æœ€ä½³æ¨¡å‹å¯ä»¥è¢«å„²å­˜ä»¥ä¾›æ¸¬è©¦ä½¿ç”¨ï¼Œä¹Ÿæä¾›loggingçš„æ©Ÿåˆ¶ï¼Œä»¥è®“è¨“ç·´éç¨‹ä¸­çš„æ¨¡å‹çš„æˆæ•ˆå¯ä»¥ç”¨Tensorboardä¾†éš¨æ™‚æª¢è¦–ã€‚

æ–¼æ¯æ¬¡å¯¦é©—ï¼Œæ ¹æ“šæˆ‘å€‘æ‰€åˆ¶å®šçš„è¦ç¯„å‰µç«‹ä¸€å€‹å…¨æ–°çš„å¯¦é©—è¨­å®šè³‡æ–™å¤¾ï¼Œåœ¨å…¶ä¸­å®šç¾©æ¨¡å‹ã€æ¨¡å‹åƒæ•¸ã€å„ä»»å‹™è¡¡é‡æŒ‡æ¨™ã€è³‡æ–™å‰è™•ç†æ–¹æ³•ï¼Œå³å¯èˆ‡æˆ‘å€‘çš„å¯¦é©—å…±ç”¨æ¨¡çµ„é€²è¡Œä¸²æ¥æ•´åˆï¼Œè®“æ¯ä¸€æ¬¡çš„å¯¦é©—éƒ½å¯ä»¥è¢«ç°¡æ˜“åœ°è¤‡è£½ã€è¡¡é‡ã€èª¿æ•´ã€‚

ä»¥ä¸‹å°‡é€²ä¸€æ­¥ä»‹ç´¹æ­¤æ¡†æ¶çš„ 1. [è³‡æ–™å¤¾æ¶æ§‹](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E8%B3%87%E6%96%99%E5%A4%BE%E6%9E%B6%E6%A7%8B) 2. [å¯¦é©—åŸ·è¡Œæ–¹æ³•](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E5%AF%A6%E9%A9%97%E5%9F%B7%E8%A1%8C%E6%96%B9%E6%B3%95
) 3. [ç¯„ä¾‹æª”èªªæ˜](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E7%AF%84%E4%BE%8B%E6%AA%94%E8%AA%AA%E6%98%8E
) 4. [è³‡æ–™å‰è™•ç†å°å·¥å…·](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E5%B0%8F%E5%B7%A5%E5%85%B7) 

æ­¤ç¨‹å¼ç‚ºbetaç‰ˆï¼Œè‹¥æ–¼ä½¿ç”¨ä¸­æœ‰ç–‘å•æˆ–å»ºè­°ï¼Œå¯ä»¥æ–¼[æ„è¦‹å›é¥‹](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E6%84%8F%E8%A6%8B%E5%9B%9E%E9%A5%8B)æä¾›çµ¦æˆ‘å€‘ï¼Œæˆ‘å€‘å°‡æœƒå°æ­¤æ¡†æ¶é€²è¡Œèª¿æ•´ã€‚
å¦å¤–ï¼Œåœ¨æŠŠå¯¦é©—ç´å…¥æ­¤æ¡†æ¶çš„éç¨‹ä¸­ï¼Œéº»ç…©ä¹Ÿå¹«æˆ‘å€‘å¡«å¯«[å¯¦é©—ç´€éŒ„è¡¨](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E5%AF%A6%E9%A9%97%E8%A8%98%E9%8C%84%E8%A1%A8)ï¼Œå·²æ–¹ä¾¿æˆ‘å€‘è¿½è¹¤é€²åº¦ã€‚

## ç›®éŒ„: 

- [ç°¡ä»‹](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E7%B0%A1%E4%BB%8B)
- [è³‡æ–™å¤¾æ¶æ§‹](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E8%B3%87%E6%96%99%E5%A4%BE%E6%9E%B6%E6%A7%8B)
- [å¯¦é©—åŸ·è¡Œæ–¹æ³•](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E5%AF%A6%E9%A9%97%E5%9F%B7%E8%A1%8C%E6%96%B9%E6%B3%95)
    - [Step 1: å®‰è£dependencies](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-1-%E5%AE%89%E8%A3%9Ddependencies)
    - [Step 2: ä¸‹è¼‰åŸå§‹è³‡æ–™](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-2-%E4%B8%8B%E8%BC%89%E5%8E%9F%E5%A7%8B%E8%B3%87%E6%96%99)
    - [Step 3: æ¸¬è©¦å¯¦é©—æ˜¯å¦å¯åŸ·è¡Œ](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-3-%E6%B8%AC%E8%A9%A6%E5%AF%A6%E9%A9%97%E6%98%AF%E5%90%A6%E5%8F%AF%E5%9F%B7%E8%A1%8C)
    - [Step 4: å»ºæ§‹æ–°å¯¦é©—](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-4-%E5%BB%BA%E6%A7%8B%E6%96%B0%E5%AF%A6%E9%A9%97)
        - [1) å¯¦é©—æ¨¡çµ„](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#1-%E5%AF%A6%E9%A9%97%E6%A8%A1%E7%B5%84-experiment_modulepy)
        - [2) æ¨¡å‹](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#2-%E6%A8%A1%E5%9E%8B-modelpy)
        - [3) å‰è™•ç†](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#3-%E8%B3%87%E6%96%99%E5%89%8D%E8%99%95%E7%90%86-dataset_builderpypreprocesspy)
    - [Step 5: åŸ·è¡Œæ–°å¯¦é©—](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-5-%E5%9F%B7%E8%A1%8C%E6%96%B0%E5%AF%A6%E9%A9%97)
        -  [1) å¯¦é©—Debug](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#1-%E5%AF%A6%E9%A9%97debug)
        -  [2) æ¨¡å‹è¨“ç·´èˆ‡æ¸¬è©¦](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#2-%E6%A8%A1%E5%9E%8B%E8%A8%93%E7%B7%B4%E8%88%87%E6%B8%AC%E8%A9%A6)
        -  [3) TensorBoard-è¨“ç·´æˆæ•ˆç›£æ§](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#3-tensorboard-%E8%A8%93%E7%B7%B4%E6%88%90%E6%95%88%E7%9B%A3%E6%8E%A7)
        -  [4) CPU/GPUåŠ é€Ÿ]()
- [ç¯„ä¾‹æª”èªªæ˜](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E7%AF%84%E4%BE%8B%E6%AA%94%E8%AA%AA%E6%98%8E)
- [å°å·¥å…·](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E5%B0%8F%E5%B7%A5%E5%85%B7)
    - 1) [è³‡æ–™å‰è™•ç†å·¥å…·: ETLBase](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#%E8%B3%87%E6%96%99%E5%89%8D%E8%99%95%E7%90%86%E5%B7%A5%E5%85%B7-etlbase)
        - 1.1) [åƒæ•¸è¨­å®š (PipeConfigBuilder)](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#1-%E5%8F%83%E6%95%B8%E8%A8%AD%E5%AE%9A-pipeconfigbuilder)
        - 1.2) [å‰è™•ç†ä¸²æ¥æ–¹å¼ (PipelineBuilder)](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#2-%E5%89%8D%E8%99%95%E7%90%86%E4%B8%B2%E6%8E%A5%E6%96%B9%E5%BC%8F-pipelinebuilder)
        - 1.3) [æ–¼.pyå®šç¾©å‰è™•ç†æ¨¡çµ„](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#3-%E6%96%BCpy%E5%AE%9A%E7%BE%A9%E5%89%8D%E8%99%95%E7%90%86%E6%A8%A1%E7%B5%84)
        - 1.4) [åŸ·è¡Œå‰è™•ç†ä¸¦å–å¾—é‹ç®—çµæœ](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#4-%E5%9F%B7%E8%A1%8C%E5%89%8D%E8%99%95%E7%90%86%E4%B8%A6%E5%8F%96%E5%BE%97%E9%81%8B%E7%AE%97%E7%B5%90%E6%9E%9C)
        - 1.5) [ä¸­ç¹¼æª”æš«å­˜åŠŸèƒ½](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#5-%E4%B8%AD%E7%B9%BC%E6%AA%94%E6%9A%AB%E5%AD%98%E5%8A%9F%E8%83%BD)
        - 1.6) [Dependencyè¦–è¦ºåŒ–ä»‹ç´¹](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#6-dependency%E8%A6%96%E8%A6%BA%E5%8C%96%E4%BB%8B%E7%B4%B9)
    - 2) [blockPrinting](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#utilsblockprint)



# è³‡æ–™å¤¾æ¶æ§‹ 
ä»¥ä¸‹ç‚ºè³‡æ–™å¤¾æ¶æ§‹ï¼Œæ¨™ä¸Š * çš„æª”æ¡ˆç‚ºå¯¦é©—åŸ·è¡Œå¾Œï¼Œæ‰æœƒç”Ÿæˆçš„æª”æ¡ˆæˆ–è³‡æ–™å¤¾ï¼›æ¨™ä¸Š V çš„ç‚ºç‰¹å®šå¯¦é©—å°ˆå±¬ä¹‹å¯¦é©—æª”æˆ–æª”æ¡ˆå¤¾ï¼›

æ¨™ä¸ŠğŸŸ ç‚ºé ˆç”±å¯¦é©—è€…[è‡ªè¡Œå»ºç½®](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-4-%E5%BB%BA%E6%A7%8B%E6%96%B0%E5%AF%A6%E9%A9%97)ä¹‹å¯¦é©—æª”æˆ–è³‡æ–™å¤¾ï¼›æ¨™ä¸ŠğŸŸ¢ç‚ºé ˆåŸ·è¡Œä¹‹æª”æ¡ˆï¼ŒåŒ…å«[æª”æ¡ˆä¸‹è¼‰](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-2-%E4%B8%8B%E8%BC%89%E5%8E%9F%E5%A7%8B%E8%B3%87%E6%96%99)èˆ‡[å¯¦é©—é‹è¡Œ](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-5-%E5%9F%B7%E8%A1%8C%E6%96%B0%E5%AF%A6%E9%A9%97)ï¼›æ¨™ä¸ŠğŸ”µç‚ºé ˆ[è‡ªè¡Œä¸‹è¼‰](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#step-2-%E4%B8%8B%E8%BC%89%E5%8E%9F%E5%A7%8B%E8%B3%87%E6%96%99)ä¹‹æª”æ¡ˆã€‚

```
.
â”œâ”€â”€ data                                                 # å¯¦é©—è³‡æ–™
|    â”œâ”€â”€ source                                            # å­˜æ”¾åŸå§‹è³‡æ–™ 
|    |      â”œâ”€â”€ ğŸŸ¢download_data_from_google_drive.ipynb      # å¾google_dirveä¸‹è¼‰åŸå§‹è³‡æ–™ç”¨
|    |      â”œâ”€â”€ ğŸ”µgoogle_drive.json                          # ä¸²æ¥google_driveç”¨çš„api-keysï¼Œä¸‹è¼‰æ–¹å¼åƒè€ƒ download_data_from_google_drive.ipynb
|    |      â”œâ”€â”€ ğŸ”µsample_chid.txt                            # åŸå§‹è³‡æ–™
|    |      â”œâ”€â”€ ğŸ”µsample_idx_map.npy                         # åŸå§‹è³‡æ–™
|    |      â”œâ”€â”€ ğŸ”µsample_zip_if_cca_cdtx0001_hist.csv        # ...
|    |      â”œâ”€â”€ ğŸ”µsample_zip_if_cca_cust_f.csv               # ...
|    |      â””â”€â”€ ğŸ”µsample_zip_if_cca_y.csv                    # åŸå§‹è³‡æ–™ 
|    | 
|    â”œâ”€â”€ * sample                                        # å­˜æ”¾åŸå§‹è³‡æ–™downsampleå¾Œçš„è³‡æ–™
|    | 
|    â”œâ”€â”€ *V [experiment_group_name]                      # å­˜æ”¾ç‰¹å®šé¡å‹çš„å¯¦é©—(e.g., rnn)æ‰€éœ€ä¹‹è³‡æ–™
|    |      â”œâ”€â”€ * tmp                                      # ä¸­ç¹¼æª”
|    |      â””â”€â”€ * result                                   # çµæœæª”
|    â”œâ”€â”€ *V [experiment_name]                            # å­˜æ”¾ç‰¹å®šå¯¦é©—(e.g., ex1)ç”¨è³‡æ–™
|    |      â”œâ”€â”€ * tmp                                      # ä¸­ç¹¼æª”
|    |      â””â”€â”€ * result                                   # çµæœæª”
|    â”œâ”€â”€ *V [experiment_name]                            
|    â””â”€â”€ ... 
|
â”œâ”€â”€ common                                               # å…±ç”¨æ¨¡çµ„           
|    â”œâ”€â”€ ETLBase.py                                        # å‰è™•ç†ç”¨å°å·¥å…· 
|    â”œâ”€â”€ utils.py                                          
|    â”œâ”€â”€ pl_module.py                                    # å…§å«å¤šä»»å‹™å¯¦é©—å…±ç”¨ä¹‹æŠ½è±¡æ¨¡çµ„ 
|    â””â”€â”€ __init__.py 
|    
â”œâ”€â”€ experiments                                          # V å¯¦é©—æ¨¡çµ„ 
|    â”œâ”€â”€VğŸŸ [experiment_name]                              # V ç‰¹å®šå¯¦é©—ä¹‹å¯¦é©—æ¨¡çµ„ 
|    |      â”œâ”€â”€VğŸŸ experiment_module.py                    # V å¯¦é©—è¨­å®šæ¨¡çµ„                                
|    |      â”œâ”€â”€VğŸŸ model.py                                # V æ¨¡å‹æ¨¡çµ„ 
|    |      â”œâ”€â”€VğŸŸ preprocess_operators.py                 # V è³‡æ–™å‰è™•ç†æ¨¡çµ„ (see ex3)
|    |      â”œâ”€â”€VğŸŸ config_pipeline.py                      # V è³‡æ–™å‰è™•ç†æ¨¡çµ„ (see ex3)
|    |      â”œâ”€â”€VğŸŸ connect_pipeline.py                     # V è³‡æ–™å‰è™•ç†æ¨¡çµ„ (see ex3)
|    |      â””â”€â”€VğŸŸ __init__.py                        
|    â””â”€â”€VğŸŸ [experiment_name]
|    â””â”€â”€ ...
|
â”œâ”€â”€ *checkpoint                                          # å„²å­˜æ¨¡å‹æš«å­˜æª” 
|    â”œâ”€â”€ *V [experiment_name]                              # å„²å­˜ç‰¹å®šå¯¦é©—çš„æ¨¡å‹æš«å­˜æª”
|    |      â”œâ”€â”€ *V epoch964-loss0.00.ckpt                    # V æœ€ä½³æ¨¡å‹çš„æš«å­˜æª”
|    |      â””â”€â”€ *V last.ckpt                                 # V æœ€å¾Œä¸€å€‹epochçš„æ¨¡å‹æš«å­˜æª”   
|    â”œâ”€â”€ *V [experiment_name]
|    â””â”€â”€ ... 
|
â”œâ”€â”€ *logs                                                # å­˜æ”¾è¨“ç·´LOG: å„ä»»å‹™by-iterationçš„æˆæ•ˆã€å¯¦é©—åƒæ•¸ã€æ¨¡å‹æ¶æ§‹åœ– 
|    â””â”€â”€ tensorboard 
|           â”œâ”€â”€ *V [experiment_name]                       # å„²å­˜ç‰¹å®šå¯¦é©—çš„LOG 
|           |       â”œâ”€â”€ *V version_0                         # å„²å­˜ç¬¬1æ¬¡å¯¦é©—çš„LOG 
|           |       â”œâ”€â”€ *V version_1                         # å„²å­˜ç¬¬2æ¬¡å¯¦é©—çš„LOG 
|           |       â””â”€â”€ ... 
|           â”œâ”€â”€ *V [experiment_name]                      
|           â””â”€â”€ ... 
â”œâ”€â”€ğŸŸ¢run_project.py                                      # å¯¦é©—åŸ·è¡Œæª” 
â”œâ”€â”€ requirements.txt 
â””â”€â”€ ReadMe.md 
```



# å¯¦é©—åŸ·è¡Œæ–¹æ³• 

## Step 1: å®‰è£dependencies 

é¦–å…ˆå°‡ç›¸é—œå¥—ä»¶é€²è¡Œå®‰è£ã€‚

åŸ·è¡Œ: 
`sh install_packages.sh`

è‹¥è¦ä½¿ç”¨Nvidia GPUï¼Œé ˆå®‰è£GPUç‰ˆæœ¬pytorchï¼Œè©³æƒ…è«‹è¦‹ï¼šhttps://pytorch.orgã€‚


## Step 2: ä¸‹è¼‰åŸå§‹è³‡æ–™ 

* æ–¹æ³•ä¸€: è‡³data/sourceåŸ·è¡Œ**download_data_from_google_drive.ipynb**é€²è¡Œä»¥ä¸‹åŸå§‹è³‡æ–™çš„ä¸‹è¼‰
```
ğŸ”µsample_chid.txt                            # åŸå§‹è³‡æ–™
ğŸ”µsample_idx_map.npy                         # åŸå§‹è³‡æ–™
ğŸ”µsample_zip_if_cca_cdtx0001_hist.csv        # ...
ğŸ”µsample_zip_if_cca_cust_f.csv               # ...
ğŸ”µsample_zip_if_cca_y.csv                    # åŸå§‹è³‡æ–™ 
```



* æ–¹æ³•äºŒ: è‡ªè¡Œä¸‹è¼‰ä»¥ä¸Šè³‡æ–™è‡³data/sourceã€‚

è‹¥æ¡ç”¨æ–¹æ³•ä¸€ï¼Œé ˆè‡³google developer platformä¸‹è¼‰ğŸ”µgoogle_drive.jsonï¼Œä¸²æ¥google_driveç”¨çš„api-keysï¼Œä¸‹è¼‰æ–¹å¼åƒè€ƒ download_data_from_google_drive.ipynbã€‚

## Step 3: æ¸¬è©¦å¯¦é©—æ˜¯å¦å¯åŸ·è¡Œ 

åŸ·è¡ŒFastDebug: 
`python run_project.py -m fastdebug -e ex1` 


æ­¤ç¨‹å¼æœƒå°experiments/ex1è³‡æ–™å¤¾æ‰€å®šç¾©ä¹‹å¯¦é©—é€²è¡Œdebugã€‚éç¨‹ä¸­æœƒå°åŸå§‹è³‡æ–™é€²è¡Œå‰è™•ç†ï¼Œä¸¦å°‡çµæœèˆ‡ä½”å­˜æª”å„²å­˜æ–¼`data/sample`ã€`data/rnn/tmp`ã€`data/rnn/result`ã€`data/ex1/tmp`ã€`data/ex1/result`ï¼Œæ¥è‘—ï¼Œè³‡æ–™è™•ç†å®Œå¾Œï¼Œå°±æœƒé€²è¡Œ1å€‹stepçš„trainingå’Œvalidationï¼Œä»¥å¿«é€Ÿé©—è­‰æ¨¡å‹ã€ç¨‹å¼çš„é‹ä½œæ­£å¸¸ã€‚

## Step 4: å»ºæ§‹æ–°å¯¦é©—: 

å¯ä»¥è¤‡è£½[ex3](https://github.com/udothemath/ncku_customer_embedding/tree/enhance_preprocess_module/experiments/ex3)è³‡æ–™å¤¾ï¼Œå¿…å°‡å…¶æ”¹ç‚ºå¯¦é©—è€…æ¬²å‘½åçš„å¯¦é©—åç¨±ï¼ˆe.g., ex4)ï¼Œä¸¦ä¿®æ”¹å…¶ä¸­çš„`experiment_module.py`/`model.py`/`config_pipeline.py`/`connect_pipeline.py`/`preprocess_operators.py`ã€‚å…¶ä¸­`experiment_module.py`ç‚ºå¯¦é©—æ¨¡çµ„ï¼Œ`model.py`ç‚ºæ¨¡å‹ï¼Œ`config_pipeline.py`/`connect_pipeline.py`/`preprocess_operators.py`ç‚ºå‰è™•ç†ç¨‹å¼ã€‚

ä»¥ä¸‹å°‡ä»¥ex1ç‚ºç¯„ä¾‹ï¼Œåˆ†åˆ¥èªªæ˜æ­¤ä¸‰é¡ç¨‹å¼çš„å»ºæ§‹æ–¹å¼: 

### 1) å¯¦é©—æ¨¡çµ„ (`experiment_module.py`)

å¯¦é©—æ¨¡çµ„å¿…é ˆåŒ…å«ä¸‰å€‹Class: `ExperimentConfig`ã€`ExperimentalMultiTaskDataModule`å’Œ`ExperimentalMultiTaskModule`ï¼Œ`ExperimentConfig`å®šç¾©äº†å¯¦é©—åç¨±ã€å¯¦é©—åƒæ•¸ã€ä»¥åŠæœ€ä½³æ¨¡å‹çš„æš«å­˜æª”åç¨±ï¼Œ`ExperimentalMultiTaskDataModule`å®šç¾©äº†è³‡æ–™å‰è™•ç†ã€è¨“ç·´ä»¥åŠæ¸¬è©¦è³‡æ–™ï¼Œ`ExperimentalMultiTaskModule`å®šç¾©äº†å¤šä»»å‹™æ¨¡å‹ã€ä»»å‹™åç¨±ã€ä»»å‹™ç›®æ¨™å‡½æ•¸ä»¥åŠä»»å‹™æˆæ•ˆè¡¡é‡æŒ‡æ¨™ã€‚

ä»¥ä¸‹å°‡é‡å°æ’°å¯«æ–¹å¼é€²ä¸€æ­¥èªªæ˜: 

**1. ExperimentConfig**:
```python 

class ExperimentConfig:
    # @ExperimentDependent 
    best_model_checkpoint = 'epoch07-loss0.00.ckpt' # æœ€ä½³æ¨¡å‹çš„æš«å­˜æª”åç¨±

    name = experiment_name  # å¯¦é©—åç¨±ï¼Œéœ€å’Œè³‡æ–™å¤¾åç¨±ç›¸åŒ(e.g., ex1) 

    experiment_parameters = {                    # å¯¦é©—åƒæ•¸ 
        "model_parameters": {                      # æ¨¡å‹åƒæ•¸: æœƒæ”¾åˆ°model.pyçš„åƒæ•¸ã€‚
            "data_independent":{                     # å’Œè³‡æ–™ç„¡é—œçš„æ¨¡å‹åƒæ•¸ï¼Œ(e.g., hidden_dims ä¸­é–“å±¤ç¶­åº¦, n_layers å±¤æ•¸, ...) 
                'hidden_dims': 64,              
                'n_layers': 2, 
                'cell': 'LSTM', 
                'bi': False
            },
            "data_dependent": {                      # å’Œè³‡æ–™ç›¸é—œä¹‹æ¨¡å‹åƒæ•¸ï¼Œ(e.g., dense_dims è¼¸å…¥ä¹‹æ•¸å€¼å‹ç‰¹å¾µç¶­åº¦, use_chid æ˜¯å¦ä½¿ç”¨é¡§å®¢IDç‚ºç‰¹å¾µ, out_dims æ¨¡å‹è¼¸å‡ºçš„ç¶­åº¦)  
                'dense_dims': dense_dims, 
                'sparse_dims': sparse_dims,
                'use_chid': use_chid, 
                'out_dims': out_dims,
                'class_outputs': class_outputs 
            }
        },
        "training_parameters":{                      # è¨“ç·´åƒæ•¸ï¼Œ(e.g., dropout, warmup_epochs, annealing_cycle_epochs) 
            "dropout": 0.5, 
            "warmup_epochs": 5, 
            "annealing_cycle_epochs": 40
        }
    }
```

* å…¶ä¸­ï¼Œdropout/warmup_epochs/annealing_cycle_epochsè‹¥ä¸æä¾›ï¼Œé æ¸¬å‰‡åˆ†åˆ¥æœƒçµ¦0.5, 5, 40ã€‚warmup_epochså’Œannealing_cycle_epochsæœƒè¼¸å…¥ä»¥ä¸‹learning rate schedulerï¼Œé€²è¡Œlearning rateå‹•æ…‹èª¿æ•´ï¼Œä»¥åŠ é€Ÿæ¨¡å‹è¨“ç·´ã€‚

```python 
LinearWarmupCosineAnnealingLR(optimizer, 
 warmup_epochs=self._warmup_epochs, 
 max_epochs=self._annealing_cycle_epochs 
)
```
**2. ExperimentalMultiTaskDataModule**:


```python 
class ExperimentalMultiTaskDataModule(BaseMultiTaskDataModule):
    # @blockPrinting
    def prepare_data(self):
        self.train_dataset = train_dataset.run()[0] 
        self.test_dataset = test_dataset.run()[0]
```

* æ–¼prepare_dataå®šç¾©train_datasetå’Œtest_datasetã€‚æ­¤å…©å€‹ç‰©ä»¶é ˆç‚ºtorch.utils.dataçš„TensorDatasetç‰©ä»¶ã€‚

**3. ExperimentalMultiTaskModule**:

```python 
import torch.nn.functional as F
class ExperimentalMultiTaskModule(BaseMultiTaskModule):

    def config_model(self, model_parameters, dropout): # æ­¤è™•å¼•å…¥model.pyçš„æœ€top-levelçš„nn.Moduleï¼Œæ­¤nn.Moduleåƒmodel_parameterså’Œdropoutå…©å€‹åƒæ•¸ï¼Œå¾Œé¢å°‡æ–¼model.pyé€²ä¸€æ­¥èªªæ˜å»ºæ§‹æ–¹å¼ã€‚
        return MultiTaskModel(
                model_parameters,
                dropout = dropout
            )
            
    def config_task_names(self):                                 # æ­¤è™•å®šç¾©æ¨¡å‹è¼¸å‡ºæ‰€å°æ‡‰ä¹‹ä»»å‹™åç¨± 
        return ['objmean', 'tscnt', 'label_0']
        
    def config_loss_funcs(self): 
        return [F.mse_loss, F.mse_loss, F.binary_cross_entropy]  # æ­¤è™•å®šç¾©å„ä»»å‹™ä¹‹ç›®æ¨™å‡½æ•¸ 
    
    

    def config_task_metrics(self):                               # æ­¤è™•å®šç¾©å€‹ä»»å‹™ä¹‹è¡¡é‡æŒ‡æ¨™åç¨± 
        return {
            'objmean': ['mse', 'mae'], 
            'tscnt': ['mse', 'mae'], 
            'label_0': ['acc', 'auc']
        }
    
    def config_metric_calculators(self):                         # (optional) å®šç¾©å€‹æŒ‡æ¨™åç¨±æ‰€å°æ‡‰ä¹‹æŒ‡æ¨™è¨ˆç®—å…ƒä»¶ã€‚è‹¥æœ‰æ–°æŒ‡æ¨™(émse/mae/acc/auc)æ‰éœ€å¯¦ä½œæ­¤å‡½æ•¸ã€‚
        from torchmetrics import MeanSquaredError, MeanAbsoluteError, Accuracy, AUROC
        return {
            'mse': lambda: MeanSquaredError(compute_on_step=False), 
            'mae': lambda: MeanAbsoluteError(compute_on_step=False), 
            'acc': lambda: Accuracy(compute_on_step=False),
            'auc': lambda: AUROC(compute_on_step=False, pos_label=1)
        }
    def batch_forward(self, batch):                              # æ­¤è™•æ ¹æ“šæ¨¡å‹çš„forwardæ–¹å¼å®šç¾©ä¸€å€‹batchçš„forwardï¼Œä»¥ä¾›å…±ç”¨æ¨¡çµ„çš„training/validation/testingå°‡ground_truthå’Œoutputså¥—ç”¨åˆ°lossä¸Šã€‚
        x_dense, x_sparse, objmean, tscnt, label_0 = batch
        outputs = self(x_dense, x_sparse)
        ground_truths = objmean, tscnt, label_0
        return outputs, ground_truths
```

### 2) æ¨¡å‹ (`model.py`)

model.pyçš„top-level moduleä¾ç…§nn.Moduleæ—¢æœ‰æ–¹æ³•é€²è¡Œå¯¦ä½œï¼Œä½†é ˆæ³¨æ„__init__éœ€åƒ`model_parameters`å’Œ`dropout`ï¼Œmodel_parametersç‚ºä¸€dictionaryï¼Œ
å…§å®¹ç‚º`ExperimentConfig.experiment_parameters["model_parameters"]` ä¸­`"data_independent"`ä»¥åŠ`"data_dependent"`åº•ä¸‹çš„æ‰€æœ‰åƒæ•¸ã€‚

```python 
class MultiTaskModel(torch.nn.Module):
    def __init__(self, model_parameters, dropout=0.5):
        super(MultiTaskModel, self).__init__()

        # Load parameters: 
        hidden_dims = model_parameters['hidden_dims']
        n_layers = model_parameters['n_layers'] 
        cell = model_parameters['cell'] 
        bi = model_parameters['bi'] 
        dense_dims = model_parameters['dense_dims'] 
        sparse_dims = model_parameters['sparse_dims'] 
        use_chid = model_parameters['use_chid'] 
        out_dims = model_parameters['out_dims'] 
        class_outputs = model_parameters['class_outputs']

        # Build model blocks: 
        self.rnn = ET_Rnn(
            dense_dims, 
            sparse_dims, 
            hidden_dims, 
            n_layers=n_layers, 
            use_chid=use_chid,
            cell=cell, 
            bi=bi, 
            dropout=dropout
        )
        
        self.mlps = nn.ModuleList([
            MLP(
                self.rnn.out_dim, hidden_dims=[self.rnn.out_dim // 2], out_dim=od
            ) for od in out_dims
        ])

        # Parameters used in forward 
        self.class_outputs = class_outputs

    def forward(self, *x):
        x_dense, x_sparse = x 
        logits = self.rnn(x_dense, x_sparse)
        outs = []
        for mlp, is_class in zip(self.mlps, self.class_outputs):
            out = mlp(logits)
            if is_class:
                out = torch.sigmoid(out)
            outs.append(out)
        return outs


```

### 3) è³‡æ–™å‰è™•ç† (`preprocess_operators.py`/`connect_pipeline.py`/`config_pipeline.py`)

æ­¤ä¸‰å€‹ç¨‹å¼å®šç¾©äº†ç”¢ç”ŸTensorDatasetç‰©ä»¶ä¹‹è³‡æ–™å‰è™•ç†data pipelineï¼Œå…¶ä½¿ç”¨äº†æˆ‘å€‘çš„`common/ETLBase.py`çš„`PipeConfigBuilder`ç‰©ä»¶é€²è¡Œè™•ç†æ¨¡çµ„çš„åƒæ•¸å®šç¾©ä¸¦ç”¨`PipeBuilder`é€²è¡Œä¸²æ¥çš„å®šç¾©ã€‚

è©³ç´°ä½¿ç”¨æ–¹å¼æ–¼**å°å·¥å…·**ä»‹ç´¹ã€‚


## Step 5: åŸ·è¡Œæ–°å¯¦é©—: 

ç•¶æ–°çš„å¯¦é©—å»ºæ§‹å®Œæˆï¼Œå»ºè­°ä¾ä»¥ä¸‹é †åºé€²è¡Œdebugèˆ‡è¨“ç·´: 

### 1) å¯¦é©—Debug:

**fastdebug**

é¦–å…ˆï¼ŒåŸ·è¡Œfastdebugï¼Œç¢ºä¿å³ä½¿æ¨¡å‹èˆ‡å¯¦é©—è¨­å®šä¿®æ”¹å¾Œï¼Œè¨“ç·´èˆ‡é©—è­‰çš†èƒ½é †åˆ©åŸ·è¡Œ: 

`python run_project.py -m fastdebug -e [å¯¦é©—è³‡æ–™å¤¾åç¨±]` 

**fit1batch** 

æ¥è‘—ï¼Œç‚ºäº†ç¢ºä¿æ¨¡å‹è¨­è¨ˆæ˜¯åˆç†çš„ï¼Œè®“æ¨¡å‹overfitä¸€å€‹è¨“ç·´çš„batchï¼Œæ­£å¸¸çš„ç‹€æ³ï¼Œlossè¦èƒ½å¤ æŒçºŒä¸‹é™ï¼Œlossçš„ç›£æ§åƒè€ƒ [TensorBoard-è¨“ç·´æˆæ•ˆç›£æ§](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#3-tensorboard-%E8%A8%93%E7%B7%B4%E6%88%90%E6%95%88%E7%9B%A3%E6%8E%A7)ã€‚

`python run_project.py -m fit1batch -e [å¯¦é©—è³‡æ–™å¤¾åç¨±] (-l [log_dir])` 

åŸ·è¡Œéç¨‹ä¸­ï¼Œæœƒå­˜æ”¾TensorBoardçš„Logæ–¼è³‡æ–™å¤¾`./logs/tensorboard/[å¯¦é©—è³‡æ–™å¤¾åç¨±]/version_[x]`ã€‚

### 2) æ¨¡å‹è¨“ç·´èˆ‡æ¸¬è©¦

**train** 

åŸ·è¡Œè¨“ç·´: 

`python run_project.py -m train -e [å¯¦é©—è³‡æ–™å¤¾åç¨±] (-l [log_dir])`  

æ¨¡å‹çš„validation/training performanceçš„ç›£æ§åƒè€ƒ [TensorBoard-è¨“ç·´æˆæ•ˆç›£æ§](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/README.md#3-tensorboard-%E8%A8%93%E7%B7%B4%E6%88%90%E6%95%88%E7%9B%A3%E6%8E%A7)ã€‚

è¨“ç·´éç¨‹ä¸­ï¼Œè¡¨ç¾æœ€ä½³çš„æ¨¡å‹ä»¥åŠæœ€å¾Œä¸€å€‹epochçš„æ¨¡å‹æš«å­˜æª”(.ckpt)æœƒè¢«ä¿å­˜æ–¼`./checkpoint/[å¯¦é©—è³‡æ–™å¤¾åç¨±]`ä¸­ï¼Œæ¯å¢åŠ ä¸€å€‹epochï¼Œå°±æœƒè¢«æ›´æ–°ä¸€æ¬¡ã€‚

**test**

è‹¥è¦ç”¨æ¸¬è©¦è³‡æ–™æª¢æ¸¬æ¨¡å‹çš„æœ€çµ‚çµæœï¼Œå¯ä»¥å°‡`./checkpoint/[å¯¦é©—è³‡æ–™å¤¾åç¨±]`ä¸­ï¼Œæœ€ä½³æ¨¡å‹çš„.ckptæª”æŒ‡å®šçµ¦`experiment_module.py`ä¸­`ExperimentConfig`çš„`best_model_checkpoint`åƒæ•¸ï¼Œæ¥è‘—åŸ·è¡Œ: 

`python run_project.py -m test -e [å¯¦é©—è³‡æ–™å¤¾åç¨±]`

### 3) TensorBoard-è¨“ç·´æˆæ•ˆç›£æ§ 

æ–¼terminalè¼¸å…¥`tensorboard --logdir logs/tensorboard/[å¯¦é©—è³‡æ–™å¤¾åç¨±]`ï¼Œå³å¯æ–¼ç€è¦½å™¨é–‹å•ŸTensorBoardæŸ¥çœ‹è¨“ç·´ç‹€æ³(http://localhost:6006/ )ã€‚

* _Note: _è‹¥æ˜¯åŸ·è¡Œfit1batchï¼Œå…¶ä¸­valçš„åœ–è¡¨é¡¯ç¤ºçš„ç‚ºåœ¨ä¸€å€‹è¨“ç·´çš„batchä¸Šè¡¡é‡çš„æˆæ•ˆã€‚

è‹¥è¦ä¿®æ”¹logè³‡æ–™å¤¾ï¼Œå¯ä»¥æ–¼åŸ·è¡Œæ™‚ï¼Œç”¨`-l`æŒ‡å®šæ–°logè³‡æ–™å¤¾è·¯å¾‘ï¼Œe.g., 

`python run_project.py -m [fit1batch/train] -e [å¯¦é©—è³‡æ–™å¤¾åç¨±] -l MyDirectory`ï¼Œæ­¤æ™‚ï¼Œå‰‡æ–¼terminalè¼¸å…¥`tensorboard --logdir MyDirectory/[å¯¦é©—è³‡æ–™å¤¾åç¨±]`ï¼Œå³å¯æŸ¥çœ‹è©²å¯¦é©—çµæœã€‚

è‹¥æœ‰é€²è¡Œå¯¦é©—åƒæ•¸èª¿æ•´ï¼Œå¯æ–¼ http://localhost:6006/#hparams æŸ¥çœ‹å„å¯¦é©—åƒæ•¸ä¸‹çš„æ¨¡å‹æˆæ•ˆã€‚

### 4) GPU/CPUåŠ é€Ÿï¼š

```
python run_project.py -m [fit1batch/train] -e [å¯¦é©—è³‡æ–™å¤¾åç¨±] -g [GPUæ•¸é‡] -c [ä½¿ç”¨çš„cpu workeræ•¸é‡]
```

# ç¯„ä¾‹æª”èªªæ˜


# å°å·¥å…· 

## è³‡æ–™å‰è™•ç†å·¥å…·: ETLBase 

ç‚ºäº†èƒ½è®“è³‡æ–™è½‰æ›ç‚ºèƒ½å¤ è¼¸å…¥æ¨¡å‹çš„å½¢å¼ï¼Œå¯¦é©—å»ºç½®éç¨‹ä¸­ï¼Œå¾€å¾€æœƒéœ€è¦è€—è²»è¨±å¤šçš„å¿ƒåŠ›ä¾†é€²è¡Œè³‡æ–™çš„å‰è™•ç†ï¼Œè€Œå°æ–¼ä¸åŒçš„æ¨¡å‹ç‰ˆæœ¬ï¼Œåˆæœ‰å¯èƒ½æœƒæœ‰ç›¸æ‡‰çš„ä¸ä¸€æ¨£çš„å‰è™•ç†æ–¹å¼ï¼Œéš¨è‘—å¯¦é©—çš„å¢åŠ ï¼Œå‰è™•ç†çš„ç¨‹å¼ä¹Ÿç›¸æ‡‰å¾—è®Šå¾—è¶Šä¾†è¶Šé›£ä»¥ç¶­è­·ã€‚å¦å¤–ï¼Œå»ºç«‹å‰è™•ç†ç¨‹å¼çš„éç¨‹ä¸­ï¼Œå¾€å¾€æ¶‰åŠåˆ°å¤§é‡å†—é•·çš„è³‡æ–™è½‰æ›ï¼Œå› æ­¤åœ¨é–‹ç™¼éç¨‹ä¸­ä¹Ÿå®¹æ˜“å› è³‡æ–™è½‰æ›è€Œè€½èª¤äº†é–‹ç™¼æ™‚ç¨‹ã€‚

å› æ­¤ï¼Œæˆ‘å€‘å¸Œæœ›é€éæä¾›ç°¡æ˜“å¥½ç”¨çš„å‰è™•ç†å·¥å…·ï¼Œä¸åªè®“å‰è™•ç†ç¨‹å¼æ›´æ˜“æ–¼ç†è§£ï¼Œä¹Ÿå¯ä»¥é–‹ç™¼æ›´å¿«é€Ÿã€‚æ­¤å‰è™•ç†å·¥å…·å¯ä»¥é€éè¦–è¦ºåŒ–çš„æ–¹å¼ï¼Œå°‡å‰è™•ç†éç¨‹ä¸­çš„æ¨¡å¡Šã€æ¨¡å¡Šçš„è¼¸å…¥ã€è¼¸å‡ºï¼Œä»¥åŠæ¨¡å¡Šä¹‹é–“çš„ä¸²é€£æ–¹å¼ï¼Œä»¥[æœ‰å‘åœ–(DAG)](https://zh.wikipedia.org/wiki/File:Tred-G.svg)çš„æ–¹å¼å‘ˆç¾ï¼Œè®“å‰è™•ç†çš„æ­¥é©Ÿèˆ‡é‚è¼¯å¯ä»¥ä¸€ç›®äº†ç„¶ã€‚å¦å¤–ï¼Œæ­¤å·¥å…·ä¹ŸåŠ å…¥äº†è³‡æ–™ä¸­ç¹¼æª”æš«å­˜åŠŸèƒ½ï¼Œè®“å‰è™•ç†éç¨‹ä¸­çš„ä¸­é–“ç”¢ç‰©ï¼Œå¯ä»¥è¢«ä»¥æª”æ¡ˆçš„æ–¹å¼å„²å­˜èµ·ä¾†ï¼Œè®“å¾ŒçºŒä½¿ç”¨æ­¤ä¸­é–“ç”¢ç‰©çš„è™•ç†æ¨¡å¡Šå¯ä»¥å¿«é€Ÿä»”å…¥ï¼Œé€²è¡Œå¾ŒçºŒæ¨¡å¡Šçš„èª¿æ•´ã€‚

æ­¤å·¥å…·ä¸»è¦åˆ†ç‚ºåƒæ•¸è¨­å®šæ¨¡çµ„ PipeConfigBuilder å’Œ ä¸²æ¥æ¨¡çµ„PipelineBuilder é€™å…©å¡Šï¼Œå‰è€…ç”¨ä¾†è¨­å®šå‰è™•ç†æœƒç”¨åˆ°çš„åƒæ•¸ï¼Œä¾‹å¦‚window sizeã€é¡åˆ¥æˆ–æ•¸å€¼å‹å› å­çš„æ¬„ä½åç¨±ç­‰ç­‰ï¼Œå¾Œè€…å‰‡æ˜¯ç”¨ä¾†ä¸²æ¥å‰è™•ç†æ¨¡å¡Šï¼Œä»¥ä¸‹æˆ‘å€‘å°‡å°æ­¤å·¥å…·çš„ä½¿ç”¨æ–¹å¼é€²è¡Œç°¡å–®èªªæ˜ï¼Œè©³ç´°ä½¿ç”¨æ–¹å¼è«‹åƒè€ƒ[Jupyter Notebook - Tutorial of Pipeline Tools.ipynb](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/Tutorial%20of%20Pipeline%20Tools.ipynb)ã€‚

### 1) åƒæ•¸è¨­å®š (PipeConfigBuilder)


å‡è¨­å‰è™•ç†æ¶‰åŠå…©å€‹åƒæ•¸a,bï¼Œåˆ†åˆ¥è¨­å®šç‚º1,2ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ˜¯è¨­å®š: 
```python
from common.ETLBase import PipeConfigBuilder
config = PipeConfigBuilder()
config.setups(a=1,b=2)
```
è¨­å®šå®Œæˆå¾Œï¼Œå³å¯ç”¨viewä¾†å‘ˆç¾è¨­å®šç‹€æ…‹: 

```python
config.view(summary=False)
```
![alt text](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/image/config.svg)


### 2) å‰è™•ç†ä¸²æ¥æ–¹å¼ (PipelineBuilder)

æ¥è‘—å¯ä»¥é–‹å§‹ä¾†å®šç¾©å‰è™•ç†æ–¹å¼ã€‚

* é¦–å…ˆæˆ‘å€‘å…ˆé€éä»¥ä¸‹æ–¹æ˜¯å»ºç«‹å¥½ PipelineBuilder: 
```python
from common.ETLBase import PipelineBuilder
pipe = PipelineBuilder(config)
```
PipelineBuilderå¸¶å…¥configï¼Œä»£è¡¨configä¸­æ‰€å»ºç«‹çš„é‚£äº›åƒæ•¸(a,b)ï¼ŒåŠå¯ä»¥åœ¨å‰è™•ç†ç¨‹å¼ä¸²æ¥éç¨‹ä¸­è¢«å–ç”¨ã€‚ 

* æ¥è‘—æˆ‘å€‘å¯ä»¥å»å®šç¾©è³‡æ–™è™•ç†æ¨¡å¡Šï¼Œèˆ‰ä¾‹ä¾†èªªæˆ‘å€‘å¸Œæœ›æœ‰ä¸€å€‹å¯ä»¥æŠŠa,bé€²è¡Œç›¸åŠ çš„æ¨¡å¡Š: 
```python
@pipe._func_
def plus_a_b(a=1,b=2):
    return a+b
``` 
å¦‚æ­¤æˆ‘å€‘å³å¯ä»¥æŠŠPipelineBuilderä»»åˆ¥å‡ºæ­¤æ¨¡å¡Šã€‚

* æœ€å¾Œé€²è¡Œæ¨¡å¡Šä¸²æ¥ï¼Œå‡è¨­æˆ‘å€‘æƒ³è¦è®“c = a + b, d = a + c, e = d + d, f = b + dï¼Œæˆ‘å€‘å¯ä»¥ä»¥ä¸‹é¢çš„æ–¹å¼é€²è¡Œä¸²æ¥: 

```python 
pipe.setup_connection('c = plus_a_b(a=a,b=b)')
pipe.setup_connection('d = plus_a_b(a=a,c)')
pipe.setup_connection('e = plus_a_b(d,d)')
pipe.setup_connection('f = plus_a_b(b,d)')
```

æ³¨æ„: å¸¶å…¥setup_connectionçš„pythonå­—ä¸²è«‹å‹¿åŠ å…¥æ›è¡Œå­—ç¬¦\nï¼Œæˆ–ä½¿ç”¨expressionä¾†å®šç¾©åƒæ•¸ï¼Œå¦‚: `c=plus_a_b(a=(1*2), b=(6*9))`ï¼ŒPipeConfigBuilderçš„setupä¸­å®šç¾©æˆ–æ˜¯å‡ºç¾æ–¼å…ˆå‰å®šç¾©ä¹‹setup_connectionçš„outputã€‚

æ¥è‘—ä½¿ç”¨viewå³å¯å‘ˆç¾æ•´å¼µä¸²æ¥çš„çµæœ: 

```python 
pipe.view(summary=False)
```
![alt text](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/image/pipe.svg)

### 3) æ–¼.pyå®šç¾©å‰è™•ç†æ¨¡çµ„: 

å‰è™•ç†æ¨¡å¡Šå¯çµ±ä¸€å®šç¾©æ–¼ä¸€å€‹.pyä¸­ï¼Œä¸¦ä»¥ä»¥ä¸‹æ–¹æ˜¯è¼‰å…¥PipelineBuilderä¸­: 

```python 
from experiments.ex3.config_pipeline import config
pipe = PipelineBuilder(config, func_source='experiments.ex3.preprocess_operators')
``` 
å¦‚ä»¥ä¸Šç¯„ä¾‹æ‰€å¼ï¼Œæ­¤æ–¹å¼å¯ä»¥è¼‰å…¥experiments/ex3/preprocess_operators.pyä¸­çš„æ‰€æœ‰å‡½å¼ä½œç‚ºä¸²æ¥çš„æ¨¡å¡Šä½¿ç”¨ã€‚

ä¸€æ¨£ä½¿ç”¨viewå³å¯æª¢è¦–ä¸²æ¥æ¨£è²Œ: 
```python 
pipe.view(summary=False)
```
![alt text](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/image/whole.svg)

### 4) åŸ·è¡Œå‰è™•ç†ä¸¦å–å¾—é‹ç®—çµæœ: 

æˆ‘å€‘æ‰€è¨­è¨ˆçš„å·¥å…·ï¼Œåœ¨å®šç¾©è³‡æ–™ä¸²æ¥æ–¹å¼æ™‚ï¼Œå‰è™•ç†åªæœƒé€²è¡Œä¸²æ¥ï¼Œä¸¦ä¸æœƒåŸ·è¡Œè¨ˆç®—ã€‚
**ä½†æ˜¯**åœ¨é–‹ç™¼å‰è™•ç†çš„éç¨‹ä¸­ï¼Œå¸¸å¸¸æœƒéœ€è¦æª¢è¦–å‰è™•ç†éç¨‹ä¸­çš„ä¸­ç¹¼ç”¢ç‰©ï¼Œé€éä»¥ä¸‹æ–¹æ³•å³å¯å°‡å‰è™•ç†é€²è¡Œè¨ˆç®—ä¸¦å–å¾—æŸä¸€æ¨¡å¡Šçš„è¼¸å‡ºçµæœ: 

```
pipe.f.get(verbose=True)
>> 6
```
ä¾‹å¦‚æˆ‘å€‘æƒ³è¦å–å¾—ä¸Šé¢pipeä¸­æ‰€å¾—ä¹‹fçš„å€¼ï¼Œå³å¯ç”¨getä¾†å–å¾—ï¼Œæ­¤æ™‚æ‰€æœ‰fæ‰€ä¾è³´çš„å‰è™•ç†æ¨¡å¡Šçš†æœƒé€²è¡ŒåŸ·è¡Œã€‚


### 5) ä¸­ç¹¼æª”æš«å­˜åŠŸèƒ½: 

è‹¥è¦ä½¿å‰è™•ç†é‡è¤‡ä½¿ç”¨çš„ä¸­ç¹¼ç”¢ç‰©å¯ä»¥æ›´å¿«è¢«å–å¾—ï¼Œæˆ‘å€‘æä¾›æš«å­˜åŠŸèƒ½: 

```
pipe.setup_connection(
    'df_input, feature_map = extract_feature_cols_and_encode_categoricals(df_cdtx, numeric_cols=numeric_cols, category_cols=category_cols)',
    result_dir=[
                'df_input.feather',
                'feature_map.npy'
            ]
)
```

èˆ‰ä¾‹ä¾†èªªï¼Œä¸Šé¢çš„extract_feature_cols_and_encode_categoricalså‡½æ•¸æœƒè¼¸å‡ºå…©å€‹æš«å­˜æª”ï¼Œä¸”æ­¤å…©å€‹æª”æ¡ˆéƒ½æœƒåœ¨å¾ŒçºŒè³‡æ–™è™•ç†è¢«å¤§é‡ä½¿ç”¨ã€‚ç‚ºäº†æ¸›å°‘é–‹ç™¼æ™‚é–“ï¼Œå¯ä»¥åœ¨result_dirçµ¦å…¶å„è‡ªçš„å„²å­˜æª”åé€²è¡Œæš«å­˜ï¼Œç•¶ç¨‹å¼åŸ·è¡Œåˆ°æ­¤å‡½æ•¸æ™‚ï¼Œå…¶çµæœå³æœƒè¢«è‡ªå‹•å„²å­˜ï¼Œä¸‹æ¬¡åŸ·è¡Œæ™‚ï¼Œå³æœƒç›´æ¥è¼‰å…¥æ‰€æš«å­˜çš„çµæœé€²è¡Œå¾ŒçºŒè¨ˆç®—ã€‚

ç›®å‰æ”¯æ´çš„æ ¼å¼æœ‰.feather/.h5/.npyä¸‰ç¨®æ ¼å¼ï¼Œ.featherå’Œ.h5ç‚ºå„²å­˜pandas.DataFrameç”¨çš„æ ¼å¼ã€.npyå‰‡æ˜¯ç”¨ä¾†å„²å­˜numpy.arrayç”¨çš„æ ¼å¼ã€‚

æ³¨æ„: è‹¥è¦é‡å¾æ–°åŸ·è¡Œæ­¤æ¨¡å¡Šçš„è¨ˆç®—ï¼Œé ˆæŠŠæš«å­˜æª”åˆªé™¤æ‰æœƒé‡æ–°åŸ·è¡Œï¼Œä¸¦ç”¢è£½çµæœï¼Œå¦å‰‡é è¨­ç‚ºç›´æ¥ä½¿ç”¨æš«å­˜çš„çµæœã€‚


### 6) Dependencyè¦–è¦ºåŒ–ä»‹ç´¹: 

æˆ‘å€‘äº¦æä¾›äº†Hightlight Dependencyçš„åŠŸèƒ½ï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œé€éä»¥ä¸‹æ–¹å¼å³å¯æŠŠåœ–ä¸­ï¼Œsplit_dataæ‰€ä¾è³´çš„æ¨¡çµ„èˆ‡è³‡æ–™ç”¢ç‰©éƒ½æ¨™ä½è™•ä¾†ã€‚
```
pipe.view_dependency('split_data', summary=False)
```
![alt text](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/image/dependency.svg)
è©³ç´°è¦–è¦ºåŒ–çš„é€²éšæ“ä½œè«‹åƒè€ƒ: [Jupyter Notebook - Tutorial of Pipeline Tools.ipynb](https://github.com/udothemath/ncku_customer_embedding/blob/enhance_preprocess_module/Tutorial%20of%20Pipeline%20Tools.ipynb)



## utils.blockPrint
ç”¨ä¾†æŠŠå‡½æ•¸ä¸­æœƒprintå‡ºä¾†çš„è³‡è¨Šéƒ½å½±è—èµ·ä¾†ã€‚

ä½¿ç”¨æ–¹æ³•: 

```python 
from common.utils import blockPrinting

@blockPrinting
def function_to_block():
      print('message to be blocked')
```



# å¯¦é©—è¨˜éŒ„è¡¨
|å¯¦é©—åç¨±|æ¨¡å‹åç¨±|ä»»å‹™ä¸­è‹±åç¨±|å·²å»ºæ§‹å®Œæˆå¯¦é©—è³‡æ–™å¤¾|fastdebugé‹ä½œç„¡èª¤|fit1batché‹ä½œç„¡èª¤|trainé‹ä½œç„¡èª¤|åƒæ•¸èª¿æ•´å®Œæˆ|æœ€ä½³æ¨¡å‹testç„¡èª¤|æœ€ä½³æ¨¡å‹.ckptè·¯å¾‘|
|--|:--:|--|--|--|--|--|--|--|--|
|ex1|ETRNN|ä¸‹æœˆæ¶ˆè²»ç¸½é‡‘é¡(objmean)ã€ä¸‹æœˆæ¶ˆè²»æ¬¡æ•¸(tscnt)ã€ä¸‹æœˆæ˜¯å¦æ¶ˆè²»(label_0)|V|V|V| | | | |

# æ„è¦‹å›é¥‹ 

- [1] GNNæ¨¡å‹è¼¸å…¥è³‡æ–™çš„æ–¹å¼èˆ‡å…ˆå‰ETRNNçš„ä½¿ç”¨dataloaderçš„æ–¹å¼ä¸åŒ (static graphå¯ä¸ä½¿ç”¨data loaderã€dynamic graphä»¥æ¯æœˆçš„snapshotsä½œç‚ºä¸åŒçš„graph)
- [2] Multitaskå¦‚æœæ˜¯ä½œç‚ºè¨“ç·´ä»»å‹™ä¾†å¯¦ç¾çš„è©±ï¼Œæ¯å€‹ä»»å‹™æœƒæœ‰ä¸åŒçš„loss(Recallã€AUC)ï¼Œä¸ç¢ºå®šç´€éŒ„è¨“ç·´éç¨‹æ˜¯å¦å¯ä»¥åŒæ™‚è¨˜éŒ„å¤šä»»å‹™çš„loss

# MODIFICATION: 

## New Preprocessing Model 
- [X] è¨­è¨ˆæ–°preprocess module (based on [pyflow-viz](https://pypi.org/project/pyflow-viz/)) å¹«åŠ©data pipelineçš„è¦–è¦ºåŒ–ã€‚
      - [X] è¦–è¦ºåŒ–å®Œæ•´ pipeline 
      - [X] è¦–è¦ºåŒ–dependency 
- [X] æŠŠæ­¤æ–°preprocess moduleæ‰“åŒ…é€²ex3 ä½œç‚ºä½¿ç”¨ç¯„ä¾‹
      - [X] å»ºç«‹ ex3
      - [X] æŠŠpreprocessing functions æ”¾é€²å»
- [X] refine DataNode and SelectResult:
      - [X] implement get method on DataNode and SelectResult  
      - [X] allow passing of verbose variable. 
- [X] allow visualization of configuration variable. 
- [X] let DataNode takes kargs with ETLPro class argument 
- [X] build preprocess configuration object. 
    - [X] Using pprint to make config values better visualized in the DAG graph (given a max-line-length) 
- [X] ä»»ä½•etlç¨‹å¼éƒ½å¯ä»¥è¢«ä»¥åœ–å½¢åŒ–çš„æ–¹å¼å‘ˆç¾ã€‚(åªè¦functionå®šç¾©å¥½ã€æ¥å¥½ã€configä¹Ÿå®šç¾©å¥½å³å¯) 
- [X] ç”¨ exec() è®“pipelineçš„æ’°å¯«å’Œconfigçš„assignmentå¯ä»¥æ›´è‡ªç„¶ã€‚ HARD!! 
    - [X] Allow all functions to be inserted into the PipelineBuilder in one go by 1. globals() 2. from package_name import * 
    - [ ] Allow object function to be inserted too. 
- [X] Use the setup_connection on the current ex1 pipeline. 
- [X] æ”¾ç½®data pipelineè¦–è¦ºåŒ–ç¯„ä¾‹
- [ ] è®“æ­¤å·¥å…·å®Œæ•´å–ä»£ experiment_module.py ä¸­çš„ preprocessing. 
- [ ] Scan over the code and switch public func/vars to private ones. 

# ISSUES:
- [ ] è¡Œå…§ç›¸å®¹æ€§å•é¡Œ 
      - [ ] cpu ç’°å¢ƒ 
      - [ ] gpu ç’°å¢ƒ 
- [ ] colabç›¸å®¹æ€§å•é¡Œ 
